"use strict";riot.tag2("map-box",'<div class="map-box-container {pin_clickable ? &quot;&quot; : &quot;pin-click-disabled&quot;}" id="{id}-container"> <div class="map-box-widget" id="{id}"></div> </div>','map-box .map-box-container,[riot-tag="map-box"] .map-box-container,[data-is="map-box"] .map-box-container{ position: relative; width: 100%; height: 400px; } map-box .map-box-container .map-box-widget,[riot-tag="map-box"] .map-box-container .map-box-widget,[data-is="map-box"] .map-box-container .map-box-widget{ position: absolute; top: 0; bottom: 0; left: 0; right: 0; } map-box .leaflet-map-pane,[riot-tag="map-box"] .leaflet-map-pane,[data-is="map-box"] .leaflet-map-pane{ z-index: 2 !important; } map-box .leaflet-google-layer,[riot-tag="map-box"] .leaflet-google-layer,[data-is="map-box"] .leaflet-google-layer{ z-index: 1 !important; } map-box .pin-click-disabled .leaflet-clickable,[riot-tag="map-box"] .pin-click-disabled .leaflet-clickable,[data-is="map-box"] .pin-click-disabled .leaflet-clickable{ cursor: default; }',"",function(e){function t(){o.map&&a(),o.map=L.map(o.id,o.map_options),o.map.setView(o.center()),o.map.setZoom("auto"===o.map_options.zoom?15:+o.map_options.zoom);var e=L.tileLayer("https://{s}.{base}.maps.cit.api.here.com/maptile/2.1/{type}/{mapID}/{scheme}/{z}/{x}/{y}/{size}/{format}?app_id={app_id}&app_code={app_code}&lg={language}&style={style}&ppi={ppi}",{attribution:'Map &copy; 1987-2014 <a href="https://developer.here.com">HERE</a>',subdomains:"1234",mapID:"newest",app_id:app.get("service.here.app_id"),app_code:app.get("service.here.app_code"),base:"base",maxZoom:20,type:"maptile",scheme:"ontouchstart"in window?"normal.day.mobile":"normal.day",language:"tha",style:"default",format:"png8",size:"256",ppi:"devicePixelRatio"in window&&window.devicePixelRatio>=2?"250":"72"});o.map.addLayer(e)}function i(){if(o.markers=_.map(o.pins,function(e){var t=L.marker(_.get(e,"location.coordinates"),{icon:o.YPIcon,interactive:!1,keyboard:!1,riseOnHover:!0});return o.pin_clickable&&t.bindPopup('<a href="#pins/'+e._id+'" target="_blank"><div class="pin-image" style="background-image: url('+(_.get(e,"photos.0")||util.site_url("/public/image/pin_photo.png"))+');"></div></a><div style="margin: 1rem 0;"><strong data-url="#user/'+e.owner+'">@'+app.get("app_user.name").toLowerCase()+"</strong> "+e.detail+'<a href="#pins/'+e._id+'" target="_blank" style="margin: 0 0.4rem;">View Pin</a></div>'),t.addTo(o.map),t}),o.fit_bounds&&o.markers.length>0){var e=new L.LatLngBounds(_.map(o.pins,function(e){return _.get(e,"location.coordinates")}));o.map.fitBounds(e),"auto"!==o.map_options.zoom&&setTimeout(function(){o.map.setZoom(+o.map_options.zoom||17)},300)}}function a(){o.map&&(o.map.remove(),delete o.map)}var o=this;o.id="map-box-"+util.uniqueId();var n=/^options/i;o.map=null,o.map_options={zoom:17},_.forEach(e,function(e,t){if(n.test(t)){var i=_.camelCase(t.replace(n,""));if(!i)return;"false"===e?o.map_options[i]=!1:"true"===e?o.map_options[i]=!0:o.map_options[i]=e}}),o.markers=[],o.fit_bounds=e.fitBounds||!0,o.pin_clickable="false"!==e.pinClickable,o.pins=_.filter(e.pins||[],function(e){return!!_.get(e,"location.coordinates")}),o.YPIcon=L.icon({iconUrl:util.site_url("/public/image/marker-m-3d.png"),iconSize:[36,54],iconAnchor:[16,51],popupAnchor:[0,-51]}),o.on("mount",function(){t(),i()}),o.on("unmount",function(){}),o.on("update",function(){}),o.on("updated",function(){}),o.center=function(){return 0===o.pins.length?app.get("location.default"):L.latLngBounds(_.map(o.pins,function(e){return _.get(e,"location.coordinates")})).getCenter()},o.clearMarker=function(){_.forEach(o.markers,function(e){o.map.removeLayer(e)}),o.pins=[]}}),riot.tag2("page-error",'<div id="page-error"> <div class="container"> <div class="row"> <div class="col s12 m6 offset-m3 l4 offset-l4"> <div class="spacing-large"></div> <div class="center"><i class="icon material-icons title-icon">{icon}</i> <h4 class="center">{title}</h4> <h5>{message}</h5> </div> <div class="spacing-large"></div> </div> </div> </div> </div>',"","",function(e){var t=this;t.title=e.title||"เกิดปัญหาขึ้น!",t.message=e.message||"ลองดูใหม่นะ",t.icon=e.icon||"info_outline"}),riot.tag2("page-feed",'<div id="page-feed"> <div class="container no-padding-s"> <div class="spacing"></div> <h5 class="center" if="{title}">{title}</h5> <div class="row"> <div class="col s12 m6 l4" each="{pin in pins}"> <div class="card hover-card"><a class="card-image" href="#pins/{pin._id}{pin.mock ? &quot;?mock=1&quot; : &quot;&quot;}" riot-style="background-image: url({pin.photos &amp;&amp; pin.photos.length &gt; 0 ? pin.photos[0] : util.site_url(&quot;/public/image/pin_photo.png&quot;)});"></a> <div class="card-content"> <div class="card-description"> <div class="card-author"><strong data-url="#user/{pin.owner}">@{app.get(\'app_user.name\').toLowerCase()}</strong></div> <div class="card-text" html="{util.parse_tags(pin.detail)}"></div> <div class="tag-list" if="{pin.categories &amp;&amp; pin.categories.length &gt; 0}"><a class="tag-item" each="{cat in pin.categories}" href="#tags/{cat}">{cat}</a></div><span class="card-tree-name" if="{pin.tree_name}">/ {pin.tree_name}</span><span class="card-tree-height" if="{pin.tree_height}">/ สูง {pin.tree_height} m</span><span class="card-tree-canopy" if="{pin.tree_canopy_radius}">/ ขนาด {pin.tree_canopy_radius} m</span><span class="card-tree-circum" if="{pin.tree_circumference}">/ รอบวง {pin.tree_circumference} cm</span> </div> <div class="card-meta"> <div class="meta meta-time right">{moment(pin.created_time).fromNow()}</div> <div class="meta meta-status left" data-status="{pin.status}">{pin.status}</div> </div> </div> </div> </div> </div> <div class="center"> <button class="btn waves-effect waves-light white light-blue-text" if="{has_more &amp;&amp; !is_loading}" type="button" onclick="{clickLoadMore}"><i class="icon material-icons light-blue-text">expand_more</i>โหลดเพิ่ม</button> <preloader class="small" if="{is_loading}"></preloader> </div> <div class="spacing-large"></div> </div> </div>',"","",function(e){function t(){app.busy(),i.is_loading=!0,$.ajax({url:util.site_url("/pins",app.get("service.api.url")),data:_.assign({$sort:"-created_time"},i.query,{$skip:i.skip,$limit:i.limit})}).done(function(e){var t=e.data||[];i.skip+=Math.min(t.length,i.limit),i.has_more=t.length>=i.limit,i.pins=i.pins.concat(t)}).always(function(){i.is_loading=!1,app.busy(!1),i.update()})}var i=this;i.title=e.title,i.pins=e.pins||[],i.has_more=!1,i.skip=0,i.limit=30,i.query=e.query||{},i.is_loading=!1,i.on("mount",function(){t()}),i.on("updated",function(){$(i.root).find(".card-text").each(function(e,t){var i=$(t);i.html(i.attr("html"))})}),i.clickLoadMore=function(e){t()}}),riot.tag2("page-map",'<div id="page-map"> <map-box id="map-{id}" options-zoom="auto" options-scroll-wheel-zoom="false"></map-box> <div class="container no-padding-s" id="overlay-layer"> <button class="btn-floating waves-effect waves-light white" type="button" onclick="{setMapLocationByGeolocation}"><i class="icon material-icons light-blue-text">gps_fixed</i></button> </div> <div class="input-field" id="search-input-field"> <form onsubmit="{onSubmitSearch}"> <input id="search-input" type="search" placeholder="ค้นหาคำ"> </form> </div> </div>',"","",function(e){function t(e){console.error(e.message),Materialize.toast('ไม่สามารถแสดงตำแหน่งปัจจุบันได้ <a href="/help" target="_blank">อ่านที่นี่เพื่อแก้ไข</a>',5e3,"dialog-error"),o.map.setView(app.get("location.default"),16)}function i(){function e(){return o.options.has_more&&o.options.pins.length<500}e()&&(app.busy(),o.is_loading=!0,$.ajax({url:util.site_url("/pins",app.get("service.api.url")),data:_.assign({$sort:"-created_time"},o.options.query,{$skip:o.options.skip,$limit:o.options.limit})}).done(function(t){var n=t.data||[];o.options.skip+=Math.min(n.length,o.options.limit),o.options.has_more=n.length>=o.options.limit,o.options.pins=o.options.pins.concat(n),app.set("page_map_options",o.options),e()?(a(),i()):a()}).always(function(){o.is_loading=!1,app.busy(!1)}))}function a(){riot.mount("#map-"+o.id,{pins:o.options.pins}),o.mapbox=_.get(o["map-"+o.id],"_tag"),o.map=_.get(o.mapbox,"map")}var o=this;o.id="page-map-"+util.uniqueId(),o.title=e.title,o.map=null,o.mapbox=null,o.is_loading=!1,o.options=_.assign({pins:[],has_more:!0,skip:0,limit:50,query:{}},e.options||{}),o.on("mount",function(){a(),i()}),o.setMapLocationByGeolocation=function(e){e.preventDefault(),e.stopPropagation(),o.map&&(o.map.locate({setView:!0,maxZoom:16,enableHighAccuracy:!0}),o.map.off("locationerror",t),o.map.on("locationerror",t))},o.onSubmitSearch=function(e){e.preventDefault(),e.stopPropagation();var t=$(e.target).find("#search-input"),a=t.val();o.choice_categories=[{value:"footpath",text:"ทางเท้า",selected:!1},{value:"pollution",text:"มลภาวะ",selected:!1},{value:"roads",text:"ถนน",selected:!1},{value:"publictransport",text:"ขนส่งสาธารณะ",selected:!1},{value:"garbage",text:"ขยะ",selected:!1},{value:"drainage",text:"ระบายน้ำ",selected:!1},{value:"trees",text:"ต้นไม้",selected:!1},{value:"safety",text:"ความปลอดภัย",selected:!1},{value:"violation",text:"ละเมิดสิทธิ",selected:!1}];var n=_.find(o.choice_categories,["text",a]);n&&(a=n.value),o.mapbox&&o.mapbox.clearMarker(),o.options.pins=[],o.options.skip=0,o.options.has_more=!1,a?o.options.query={categories:a}:o.options.query={},i()}}),riot.tag2("page-pin",'<div id="page-pin"> <div class="fluid-container no-padding-s"> <div class="row"> <div class="col s12 m6 offset-m6"> <div class="spacing"></div> <div class="card"> <div class="card-image" if="{pin.photos.length === 0}" href="#pins/{pin._id}" riot-style="background-image: url({util.site_url(&quot;/public/image/pin_photo.png&quot;)});"></div> <div class="card-image responsive" if="{pin.photos.length &gt; 0}"> <div class="slider-container"> <div class="image-slider" id="photo-slider"> <div class="slider-item" each="{photo in pin.photos}"> <div class="image-item"> <div class="image" riot-style="background-image: url(&quot;{util.site_url(photo)}&quot;);"></div> </div> </div> </div> </div> </div> <div class="card-content"> <div class="pin-content"> <div class="card-description"> <div class="card-author"><strong data-url="#user/{pin.owner}">@{app.get(\'app_user.name\').toLowerCase()}</strong></div> <div class="card-text" html="{util.parse_tags(pin.detail)}"></div> <div class="tag-list" if="{categories &amp;&amp; categories.length &gt; 0}"><a class="tag-item" each="{cat in categories}" href="#tags/{cat}">{cat}</a></div><span class="card-tree-name" if="{pin.tree_name}">/ {pin.tree_name}</span><span class="card-tree-height" if="{pin.tree_height}">/ สูง {pin.tree_height} m</span><span class="card-tree-canopy" if="{pin.tree_canopy_radius}">/ ขนาด {pin.tree_canopy_radius} m</span><span class="card-tree-circum" if="{pin.tree_circumference}">/ รอบวง {pin.tree_circumference} cm</span> </div> <div class="card-meta"> <div class="meta meta-time right">{moment(pin.created_time).fromNow()}</div> <div class="meta meta-status left" data-status="{pin.status}">{pin.status}</div> </div> </div> <div if="{pin.comments &amp;&amp; pin.comments.length &gt; 0}"> <div class="divider"></div> <h5 class="section-name">ความคิดเห็น</h5> <div class="comment-list"> <div class="comment-item" each="{comment in pin.comments}"> <div class="card-description"> <div class="card-author"><a href="#user/{comment.commented_by}">@{comment.commented_by}</a></div> <div class="card-text" html="{util.parse_tags(comment.detail)}"></div> </div> </div> </div> </div> </div> </div> </div> </div> </div> <div class="map-container"> <map-box pin-clickable="false" options-zoom="17" options-scroll-wheel-zoom="false" options-tap="false" options-keyboard="false"></map-box> </div> <div class="spacing-large"></div> </div>',"","",function(e){function t(){o.slider&&i(),o.$slider=$(o.root).find("#photo-slider"),o.$slider.on("init reinit",function(e){}).on("setPosition",function(e,t){}).slick({infinite:!0,speed:400,fade:o.fade,autoplay:!1,autoplaySpeed:o.autoplay_speed,accessibility:!1,cssEase:"ease-in"}),o.slider=!0}function i(){o.slider&&(o.$slider.slick("unslick"),o.slider=!1)}var a=this,o=this;o.pin=e,o.slider=!1,o.categories=util.remove_duplicate_tags(o.pin.categories,o.pin.details),o.on("mount",function(){riot.mount("#page-pin map-box","map-box",{pins:[o.pin]})}),o.on("updated",function(){var e=$(a.root).find(".card-text");e.html(e.attr("html")),t()})}),riot.tag2("page-report",'<div class="modal bottom-sheet full-sheet" id="report-input-modal"> <div class="modal-header"> <nav> <ul class="left"> <li><a class="modal-action modal-close" href="#" onclick="{clickCloseReport}">ยกเลิก</a></li> </ul> <div class="center"><a class="brand-logo" href="#"></a> <div class="modal-title">ใส่ข้อมูลพิน</div> </div> <ul class="right"></ul> </nav> </div> <div class="modal-content no-padding-s"> <div class="container no-padding-s"> <div class="row"> <div class="col s12 m6 offset-m3 l4 offset-l4"> <form id="report-form"> <input type="hidden" name="location[coordinates][]:number" value="{location.lat}"> <input type="hidden" name="location[coordinates][]:number" value="{location.lng}"> <input type="hidden" name="location[type][]:string" value="Point"> <input each="{photo in photos}" type="hidden" name="photos[]" value="{photo.url}"> <input type="hidden" name="status" value="{status}"> <input type="hidden" name="owner" value="{owner}"> <input each="{provider in providers}" type="hidden" name="provider[]" value="{provider}"> <input type="hidden" name="level" value="normal"> <input type="hidden" name="neighborhood" value="{neighborhood}"> <div class="card"> <div class="card-image" if="{photos.length === 0}" href="#report" riot-style="background-image: url({util.site_url(&quot;/public/image/pin_photo_upload.png&quot;)});"> <button class="btn-floating btn-large waves-effect waves-light white" id="add-first-image-btn" type="button" onclick="{clickPhoto}"><i class="icon material-icons large light-blue-text">add</i></button> </div> <div class="card-image responsive" if="{photos.length &gt; 0}"> <div class="slider-container"> <div class="image-slider" id="photo-slider"> <div class="slider-item" each="{photo, i in photos}" data-i="{i}"> <div class="image-item" data-i="{i}" href="#!"> <div class="image" riot-style="background-image: url(&quot;{util.site_url(photo.url)}&quot;);"></div> </div> </div> </div> </div><a class="btn-floating btn-large waves-effect waves-light" id="add-image-btn" href="#report" onclick="{clickPhoto}"><i class="icon material-icons">add</i></a> </div> <div class="card-content"> <div class="input-field" id="input-tree-name"><i class="icon material-icons prefix">local_florist</i> <div class="input" style="margin-left: 30px;"> <input name="tree_name" placeholder="ชื่อพันธุ์ไม้ / Tree Species" oninput="{changeTreeName}"> </div> </div> <div class="input-field" id="input-tree-height"><i class="icon material-icons prefix">swap_vert</i> <div class="input" style="margin-left: 30px;"> <input step="0.1" name="tree_height" placeholder="ความสูง (m) / Height (m)" oninput="{changeTreeHeight}" type="number"> </div> </div> <div class="input-field" id="input-tree-canopy-radius"><i class="icon material-icons prefix">swap_horiz</i> <div class="input" style="margin-left: 30px;"> <input step="0.1" name="tree_canopy_radius" placeholder="ขนาดทรงพุ่ม (m) / Bush Size (m)" oninput="{changeTreeCanopyRadius}" type="number"> </div> </div> <div class="input-field" id="input-tree-circumference"><i class="icon material-icons prefix">refresh</i> <div class="input" style="margin-left: 30px;"> <input step="1" name="tree_circumference" placeholder="เส้นรอบวง (cm) / Circumference (m)" oninput="{changeTreeCircumference}" type="number"> </div> </div> <div class="input-field" id="input-categories"><i class="icon material-icons prefix">local_offer</i> <div class="input"> <select class="browser-default" id="select-categories" name="categories" onchange="{changeCategories}"> <option value="">เลือกหมวดหมู่ / Choose Category</option> <option each="{cat in choice_categories}" value="{cat.value}" __selected="{cat.selected}">{cat.text}</option> </select> </div> </div> <div class="input-field" id="input-location" if="{!location}"><i class="icon material-icons prefix {location.lat ? &quot;active&quot; : &quot;&quot;}">place</i> <div class="input"> <button class="location-input btn btn-block btn-native" type="button" onclick="{clickMapLocation}">{location_text}</button> </div> </div> </div> <div class="input-field" id="input-detail"> <textarea class="validate materialize-textarea" name="detail" placeholder="ข้อมูลเพิ่มเติม / Description" oninput="{changeDetail}">{detail}</textarea> </div> <div id="input-location-complete" if="{location}"> <map-box id="preview-location" pin-clickable="false" options-dragging="false" options-zoom="{default_zoom}" options-zoom-control="false" options-scroll-wheel-zoom="false" options-double-click-zoom="false" options-touch-zoom="false" options-tap="false" options-keyboard="false"></map-box> <button class="btn-floating btn-large waves-effect waves-light white" id="edit-location-btn" type="button" onclick="{clickMapLocation}"><i class="icon material-icons large light-blue-text">edit</i></button> </div> </div> </form> </div> </div> </div> <div class="container no-padding-s"> <div class="row"> <div class="col s12 m6 offset-m3 l4 offset-l4"> <button class="btn btn-large btn-block {is_pin_complete ? &quot;&quot; : &quot;disabled&quot;}" id="submit-pin-btn" type="button" onclick="{clickSubmitReport}" __disabled="{!is_pin_complete}">โพสต์พิน / Submit</button> </div> </div> </div> </div> </div> <div class="modal bottom-sheet full-sheet" id="report-photo-modal"> <div class="modal-header"> <nav> <ul class="left"> <li><a class="modal-action modal-close" href="#report" onclick="{clickClosePhoto}">กลับ</a></li> </ul> <div class="center"><a class="brand-logo" href="#"></a> <div class="modal-title">เลือกภาพถ่าย</div> </div> <ul class="right"></ul> </nav> </div> <div class="modal-content no-padding-s"> <div class="container no-padding-s"> <div class="row card-list"> <div class="col s12 m6 offset-m3 l4 offset-l4" each="{photo, i in photos}"> <div class="card" data-i="{i}"> <div class="card-image responsive"><img riot-src="{util.site_url(photo.url)}"></div> </div> </div> <div class="col s12 m6 offset-m3 l4 offset-l4"> <div class="spacing"></div> <div class="drop-image-preview hide"></div> <div class="card-title center drop-image" name="dropzone-el"><i class="icon material-icons">photo_camera</i>เพิ่มรูป</div> </div> </div> </div> </div> </div> <div class="modal bottom-sheet full-sheet" id="report-map-modal"> <div class="modal-header"> <nav> <ul class="left"> <li><a class="modal-action modal-close" href="#report" onclick="{clickCloseMap}">กลับ</a></li> </ul> <div class="center"><a class="brand-logo" href="#"></a> <div class="modal-title">Pin Location</div> </div> <ul class="right"> <li><a href="#!" onclick="{clickLocateMe}"><i class="icon material-icons">gps_fixed</i></a></li> </ul> </nav> </div> <div class="modal-content no-padding-s"> <div class="input-location-map" id="edit-location-map"></div><a class="btn btn-large btn-block modal-close" id="submit-location-btn" onclick="{clickCloseMap}">ใช้ตำแหน่งนี้ / Pin Here</a> </div> </div> <div class="modal" id="report-uploading-modal"> <div class="modal-content"> <div class="progress"> <div class="indeterminate"></div> </div> <h4 class="center">กำลังอัพโหลด</h4> </div> </div> <div class="modal" id="report-saving-modal"> <div class="modal-content"> <div class="progress"> <div class="indeterminate"></div> </div> <h4 class="center">กำลังพิน</h4> </div> </div>','page-report .input-location-map,[riot-tag="page-report"] .input-location-map,[data-is="page-report"] .input-location-map{ position: absolute; top: 0; bottom: 0; left: 0; right: 0; } page-report .leaflet-map-pane,[riot-tag="page-report"] .leaflet-map-pane,[data-is="page-report"] .leaflet-map-pane{ z-index: 2 !important; } page-report .leaflet-google-layer,[riot-tag="page-report"] .leaflet-google-layer,[data-is="page-report"] .leaflet-google-layer{ z-index: 1 !important; }',"",function(e){function t(){return!!(window.File&&window.FileList&&window.FileReader)}function i(){var e=document.createElement("canvas");return!(!e.getContext||!e.getContext("2d"))}function a(){try{return!!new Blob}catch(e){return!1}}function o(){v(),u(),z.target=e.target,z.detail="",z.categories="",z.status=z.default_status,z.photos=[],z.map=null,z.location=null,$(z.root).find('textarea[name="detail"]').val(""),$(z.root).find('select[name="categories"]').val(""),z.update()}function n(e,t,i,a){var o=e+(t/60+i/3600);return o*("S"==a||"W"==a?-1:1)}function s(e,t){var i=void 0;i=e.split(",")[0].indexOf("base64")!==-1?atob(e.split(",")[1]):decodeURI(e.split(",")[1]);for(var a=(e.split(",")[0].split(":")[1].split(";")[0],[]),o=0;o<i.length;o++)a[o]=i.charCodeAt(o);var n=new Blob([new Uint8Array(a)],{type:"image/png"}),s=["upload","status","previewElement","previewTemplate","accepted"];return $.each(s,function(e,i){n[i]=t[i]}),n}function l(){z.dropzone||(z.dropzone=new Dropzone(z["dropzone-el"],{url:util.site_url("/api/image"),method:"POST",acceptedFiles:"image/*",paramName:"image",maxFilesize:25,previewsContainer:".drop-image-preview",previewTemplate:'<div class="dz-preview-template" style="display: none;"></div>',dictDefaultMessage:"",clickable:_.filter([$(z.target)[0],z["dropzone-el"],z["add-first-image-btn"]]),uploadMultiple:!0,autoQueue:!1,fallback:function(){$(z.root).find(".dropzone").hide(),$(z.root).find(".dropzone-error").show()}}),z.dropzone.on("addedfile",function(e){if(r(),!P||!M||!q)return void a.enqueueFile(e);var t=800,i=800,a=z.dropzone,o=new FileReader;o.addEventListener("load",function(o){var l=new Image;l.src=o.target.result,l.addEventListener("load",function(o){var r=o.target.width,c=o.target.height;return r<=t&&c<=i?void a.enqueueFile(e):(r>c?r>t&&(c*=t/r,r=t):c>i&&(r*=i/c,c=i),void EXIF.getData(e,function(){var t=this.exifdata,i=t.Orientation||!1,o=null;if(t.GPSLatitude&&t.GPSLongitude){var p=n(_.get(t,"GPSLatitude.0",0),_.get(t,"GPSLatitude.1",0),_.get(t,"GPSLatitude.2",0),_.get(t,"GPSLatitudeRef","N")),d=n(_.get(t,"GPSLongitude.0",0),_.get(t,"GPSLongitude.1",0),_.get(t,"GPSLongitude.2",0),_.get(t,"GPSLongitudeRef","N"));o=[p,d]}var u=document.createElement("canvas");u.width=r,u.height=c;var m=u.getContext("2d");if(m.save(),i)switch(i>4&&(u.width=c,u.height=r),i){case 2:m.translate(r,0),m.scale(-1,1);break;case 3:m.translate(r,c),m.rotate(Math.PI);break;case 4:m.translate(0,c),m.scale(1,-1);break;case 5:m.rotate(.5*Math.PI),m.scale(1,-1);break;case 6:m.rotate(.5*Math.PI),m.translate(0,-c);break;case 7:m.rotate(.5*Math.PI),m.translate(r,-c),m.scale(-1,1);break;case 8:m.rotate(-.5*Math.PI),m.translate(-r,0)}m.drawImage(l,0,0,r,c),m.restore(),o&&(z.location||f(o));var v=s(u.toDataURL("image/jpeg"),e),g=a.files.indexOf(e);a.files[g]=v,a.enqueueFile(v)}))})}),o.readAsDataURL(e)}).on("sendingmultiple",function(e,t,i){}).on("successmultiple",function(e,t){for(var i=0;i<e.length;i++){var a=t[i];_.assignIn(a,{width:e[i].width,height:e[i].height}),z.photos.push(a)}$("#report-uploading-modal").closeModal(),c()}).on("errormultiple",function(e,t){console.error("error:",arguments),Materialize.toast("ไม่สามารถอัพโหลดรูปได้ ("+t+")",5e3,"dialog-error"),$("#report-uploading-modal").closeModal()}).on("completemultiple",function(e){}))}function r(){$("#report-uploading-modal").openModal({dismissible:!1})}function c(){z.redirect=app.current_hash||"#feed","#report"===z.redirect&&(z.redirect="#feed"),app.goto("report");var e=$(z["report-input-modal"]),t=$(z["report-photo-modal"]);e.hasClass("open")?z.photos.length<=1&&setTimeout(function(){t.find(".modal-close").click()},1):e.openModal({ready:function(){},complete:function(){o(),k(),app.goto(z.redirect.slice(1))}}),z.update(),d()}function p(){z.is_pin_complete=!0,z.location||(z.is_pin_complete=!1),z.tree_name||(z.is_pin_complete=!1),0===z.photos.length&&(z.is_pin_complete=!1)}function d(){z.slider&&u(),z.$slider=$(z.root).find("#photo-slider"),z.$slider.on("init reinit",function(e){}).on("setPosition",function(e,t){}).slick({infinite:!0,speed:400,fade:z.fade,autoplay:!1,autoplaySpeed:z.autoplay_speed,accessibility:!1,cssEase:"ease-in"}),z.slider=!0}function u(){z.slider&&(z.$slider.slick("unslick"),z.slider=!1)}function m(){if(!z.map&&z.location){z.map=L.map(z.map_id);var e=L.tileLayer("https://{s}.{base}.maps.cit.api.here.com/maptile/2.1/{type}/{mapID}/{scheme}/{z}/{x}/{y}/{size}/{format}?app_id={app_id}&app_code={app_code}&lg={language}&style={style}",{attribution:'Map &copy; 1987-2014 <a href="https://developer.here.com">HERE</a>',subdomains:"1234",mapID:"newest",app_id:app.get("service.here.app_id"),app_code:app.get("service.here.app_code"),base:"base",maxZoom:20,type:"maptile",scheme:"ontouchstart"in window?"normal.day.mobile":"normal.day",language:"tha",style:"default",format:"png8",size:"256"});z.map.addLayer(e),z.map_marker=L.marker(app.get("location.default"),{icon:z.YPIcon}).addTo(z.map),h(z.location,{zoom:16}),z.map.on("move",_.throttle(function(){h(z.map.getCenter())},100)),z.map.on("moveend zoomend resize",function(e){h(z.map.getCenter())})}}function v(){z.map&&(z.map.remove(),delete z.map)}function g(){return!!z.map&&(z.map.locate({setView:!0,maxZoom:16,enableHighAccuracy:!0}),z.map.on("locationfound",function(e){h(z.map.getCenter(),{zoom:18})}),z.map.on("locationerror",function(e){console.error(e.message),Materialize.toast('ไม่สามารถแสดงตำแหน่งปัจจุบันได้ <a href="/help" target="_blank">อ่านที่นี่เพื่อแก้ไข</a>',5e3,"dialog-error")}),!0)}function f(e){h(e,{zoom:17}),z.location=L.latLng(e),z.update(),riot.mount("#preview-location",{pins:[{location:{coordinates:z.location,type:"Point"}}]})}function h(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!z.map||!z.map_marker)return!1;if(z.map_marker.setLatLng(e),t.zoom){var i=new L.LatLngBounds([e]);z.map.fitBounds(i),"number"==typeof t.zoom&&setTimeout(function(){z.map.setZoom(t.zoom)},300)}return!0}function b(){_.forEach([z].concat($(z.root).find("map-box").map(function(){var e=this;return e._tag}).toArray()),function(e){e.map&&(e.map.setView(z.location),setTimeout(function(){e.map.setZoom(z.default_zoom)},300),e.map.invalidateSize())})}function y(e){$("#report-input-modal").addClass("inactive"),$("#report-photo-modal").openModal({ready:function(){},complete:function(){d(),b()}})}function x(){$("#report-saving-modal").openModal({dismissible:!1});var e=$("#report-form").serializeJSON();e.categories=_.map(e.categories&&"string"==typeof e.categories?e.categories.split(","):[],function(e){return _.trim(e)}),e.tags=util.extract_tags(e.detail),e.tags=e.tags.concat(e.categories),e.created_time=Date.now(),e.updated_time=e.created_time,e.organization="583ddb7a3db23914407f9b50",$.ajax({url:util.site_url("/pins",app.get("service.api.url")),method:"post",headers:{Authorization:"Bearer "+app.get("app_token")},beforeSend:function(e){e.setRequestHeader("Content-Type","application/json"),e.setRequestHeader("Accept","application/json")},dataType:"json",data:JSON.stringify(e)}).done(function(e){o(),k(),app.goto("pins/"+e._id)}).fail(function(e){console.error("error:",e),Materialize.toast("ไม่สามารถพินปัญหาได้ ("+e+")",5e3,"dialog-error"),$("#report-saving-modal").closeModal()})}function k(){$("#report-saving-modal").closeModal(),$("#report-input-modal").closeModal(),$("#report-input-modal").removeClass("inactive")}function w(){$("#report-input-modal").addClass("inactive"),$("#report-map-modal").openModal({ready:function(){z.map?b():(z.location||(z.location=app.get("location.default")),z.update())},complete:function(){z.location&&b()}})}var z=this;z.dropzone=null,z.slider=!1,z.is_pin_complete=!1,z.redirect="",z.detail="",z.categories="",z.photos=[],z.target=e.target,z.map=null,z.map_id="edit-location-map",z.location=null,z.default_zoom=16,z.default_status="unverified",z.status=z.default_status,z.neighborhood="",z.owner=app.get("app_user._id"),z.providers=[app.get("app_user._id")],z.YPIcon=L.icon({iconUrl:util.site_url("/public/image/marker-m.png"),iconSize:[32,51],iconAnchor:[16,48],popupAnchor:[0,-51]}),z.choice_categories=[{value:"bigtree",text:"Big Tree",selected:!0},{value:"footpath",text:"ทางเท้า",selected:!1},{value:"pollution",text:"มลภาวะ",selected:!1},{value:"roads",text:"ถนน",selected:!1},{value:"publictransport",text:"ขนส่งสาธารณะ",selected:!1},{value:"garbage",text:"ขยะ",selected:!1},{value:"drainage",text:"ระบายน้ำ",selected:!1},{value:"trees",text:"ต้นไม้",selected:!1},{value:"safety",text:"ความปลอดภัย",selected:!1},{value:"violation",text:"ละเมิดสิทธิ",selected:!1}];var P=a(),q=i(),M=t();z.on("update",function(){z.location_text=z.location&&"number"==typeof z.location.lat?"ปักตำแหน่งแล้ว / Pinned":"ใส่ตำแหน่ง / Pin Location",p()}),z.on("mount",function(){}),z.on("unmount",function(){}),z.on("updated",function(){l(),m()}),z.showReportView=c,z.changeDetail=function(e){z.detail=e.currentTarget.value,z.update()},z.changeTreeName=function(e){z.tree_name=e.currentTarget.value,z.update()},z.changeTreeHeight=function(e){z.tree_height=e.currentTarget.value?+e.currentTarget.value:void 0,z.update()},z.changeTreeCanopyRadius=function(e){z.tree_canopy_radius=e.currentTarget.value?+e.currentTarget.value:void 0,z.update()},z.changeTreeCircumference=function(e){z.tree_circumference=e.currentTarget.value?+e.currentTarget.value:void 0,z.update()},z.changeCategories=function(e){z.categories=e.currentTarget.value,z.update()},z.clickPhoto=function(e){e.preventDefault(),e.stopPropagation(),y()},z.changePhotoText=function(e){var t=+$(e.target).attr("data-i");z.photos[t].text=e.value},z.clickMapLocation=function(e){e.preventDefault(),e.stopPropagation(),w()},z.clickLocateMe=function(e){e.preventDefault(),e.stopPropagation(),g()},z.clickSubmitReport=function(e){e.preventDefault(),e.stopPropagation(),x()},z.clickClosePhoto=function(e){$("#report-input-modal").removeClass("inactive")},z.clickCloseMap=function(e){f(z.map.getCenter()),$("#report-input-modal").removeClass("inactive")},z.clickCloseReport=function(e){e.preventDefault(),e.stopPropagation(),o(),k(),app.goto(z.redirect)}}),riot.tag2("preloader",'<div class="preloader-wrapper active {class}"> <div class="spinner-layer spinner-blue-only"> <div class="circle-clipper left"> <div class="circle"></div> </div> <div class="gap-patch"> <div class="circle"></div> </div> <div class="circle-clipper right"> <div class="circle"></div> </div> </div> </div>',"","",function(e){var t=this;t.class=e.class});